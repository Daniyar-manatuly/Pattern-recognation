import cv2
import torch
import torchvision
from torchvision.transforms import functional as F

# Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ð¼ Ð¿Ñ€ÐµÐ´Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð½ÑƒÑŽ Ð¼Ð¾Ð´ÐµÐ»ÑŒ Faster R-CNN
model = torchvision.models.detection.fasterrcnn_resnet50_fpn(pretrained=True)
model.eval()  # ÐŸÐµÑ€ÐµÐ²Ð¾Ð´ Ð² Ñ€ÐµÐ¶Ð¸Ð¼ Ð¸Ð½Ñ„ÐµÑ€ÐµÐ½ÑÐ°

# Ð¡Ð¿Ð¸ÑÐ¾Ðº ÐºÐ»Ð°ÑÑÐ¾Ð² COCO (Faster R-CNN Ð¾Ð±ÑƒÑ‡ÐµÐ½ Ð½Ð° Ð½Ð¸Ñ…)
PERSON_CLASS_ID = 1  # "Ð§ÐµÐ»Ð¾Ð²ÐµÐº"

# Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ
image_path = "C:/Users/opste/Downloads/IMG_20240607_164552_287.jpg"
image = cv2.imread(image_path)

# ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð² RGB (PyTorch Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ RGB)
image_rgb = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)
image_tensor = F.to_tensor(image_rgb).unsqueeze(0)  # Ð’ Ñ‚ÐµÐ½Ð·Ð¾Ñ€

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¼Ð¾Ð´ÐµÐ»ÑŒ Faster R-CNN
with torch.no_grad():
    predictions = model(image_tensor)

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ (Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ñ€Ð¸ÑÐ¾Ð²Ð°Ñ‚ÑŒ Ð½Ð° Ð½ÐµÐ¼)
output_image = image.copy()

# Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ÑƒÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð»Ð¸Ñ†Ð° (ÑƒÐ±Ð¸Ñ€Ð°ÐµÐ¼ Ñ€ÑƒÐºÐ¸ Ð¸ Ñ„Ð¾Ð½)
for i, score in enumerate(predictions[0]["scores"]):
    if score > 0.9:  # ÐŸÐ¾Ñ€Ð¾Ð³ ÑƒÐ²ÐµÑ€ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ Ð²Ñ‹ÑˆÐµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð±ÐµÐ¶Ð°Ñ‚ÑŒ Ñ€ÑƒÐº
        label = predictions[0]["labels"][i].item()
        if label == PERSON_CLASS_ID:  # ÐžÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð»ÑŽÐ´ÐµÐ¹
            x1, y1, x2, y2 = map(int, predictions[0]["boxes"][i].tolist())
            width, height = x2 - x1, y2 - y1

            # Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ Ð¿Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ€Ñƒ Ð¾Ð±ÑŠÐµÐºÑ‚Ð° (Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸ÑÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ñ€ÑƒÐºÐ¸)
            if width > 50 and height > 50:
                cv2.rectangle(output_image, (x1, y1), (x2, y2), (0, 255, 0), 2)

# ðŸ”¹ **Ð£Ð¼ÐµÐ½ÑŒÑˆÐ°ÐµÐ¼ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ´ Ð¿Ð¾ÐºÐ°Ð·Ð¾Ð¼**
scale_percent = 50  # Ð£Ð¼ÐµÐ½ÑŒÑˆÐ°ÐµÐ¼ Ð½Ð° 50%
new_width = int(output_image.shape[1] * scale_percent / 100)
new_height = int(output_image.shape[0] * scale_percent / 100)
resized_image = cv2.resize(output_image, (new_width, new_height))

# ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑƒÐ¼ÐµÐ½ÑŒÑˆÐµÐ½Ð½Ð¾Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ
cv2.imshow("Faster R-CNN Face Detection", resized_image)
cv2.waitKey(0)
cv2.destroyAllWindows()
